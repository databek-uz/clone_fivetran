# ==============================================
# Flow: Raw to Bronze - Users Data Cleaning
# ==============================================

name: raw_to_bronze_users
description: Clean and standardize users data from raw to bronze layer

source:
  connection: minio_raw
  type: object_storage

  path: postgres/users/
  format: parquet

  # Read options
  read_options:
    merge_schema: true
    recursive: true

target:
  connection: minio_bronze
  type: object_storage

  path: users/
  format: parquet
  partition_by:
    - country
    - year
    - month

  write_mode: append
  compression: snappy

# Transformations
transformation:
  enabled: true
  type: pyspark

  # Transformation steps
  steps:
    - name: remove_duplicates
      type: deduplicate
      columns:
        - id
      keep: last

    - name: clean_email
      type: transform
      column: email
      expression: "lower(trim(email))"

    - name: standardize_phone
      type: transform
      column: phone
      expression: "regexp_replace(phone, '[^0-9+]', '')"

    - name: add_partition_columns
      type: add_columns
      columns:
        country: "coalesce(country, 'UNKNOWN')"
        year: "year(created_at)"
        month: "month(created_at)"

    - name: filter_invalid
      type: filter
      condition: "email IS NOT NULL AND email != '' AND id IS NOT NULL"

    - name: add_metadata
      type: add_columns
      columns:
        processed_at: "current_timestamp()"
        data_source: "'postgres_users'"
        layer: "'bronze'"

data_quality:
  enabled: true
  checks:
    - name: no_null_ids
      type: not_null
      column: id

    - name: valid_emails
      type: regex
      column: email
      pattern: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"

    - name: unique_emails
      type: unique
      columns:
        - email

schedule:
  enabled: true
  cron: "30 */6 * * *"  # Every 6 hours at minute 30
  timezone: Asia/Tashkent
  depends_on:
    - postgres_users_to_raw

metadata:
  owner: data_engineering
  sla: 1h
  priority: high
  tags:
    - bronze
    - users
    - cleaning
    - transformation
